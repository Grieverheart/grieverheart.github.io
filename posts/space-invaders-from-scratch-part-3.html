<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Space Invaders from Scratch - Part 3 | NICK TASIOS</title>
<link href="../assets/css/common.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<meta name="theme-color" content="#404040">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://www.nicktasios.nl/posts/space-invaders-from-scratch-part-3.html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="google-site-verification" content="VDWyLavVScx9_TFKSYp-w9DkfulCPL2LjFZwbceYyu4">
<meta name="author" content="Nick Tasios">
<link rel="prev" href="space-invaders-from-scratch-part-2.html" title="Space Invaders from Scratch - Part 2" type="text/html">
<link rel="next" href="space-invaders-from-scratch-part-4.html" title="Space Invaders from Scratch - Part 4" type="text/html">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
     
    <header id="header"><div id="menu_content">
            
    <div id="brand"><a href="../" title="NICK TASIOS" rel="home">

        <span id="blog-title">NICK TASIOS</span>
    </a></div>

            

            
    <nav id="menu"><input type="checkbox"><div id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <ul>
<li>
                <li><a href="../projects/">Projects</a></li>
                <li><a href=".">Blog</a></li>
                <li><a href="../about/">About</a></li>
        
        
        </ul></nav>
</div>
    </header><div id="container">
         <main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Space Invaders from Scratch - Part 3</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Nick Tasios
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2018-04-27T10:47:02+02:00" itemprop="datePublished" title="2018-04-27 10:47">2018-04-27 10:47</time></a></p>
        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>In this series of posts, I am going to create a clone of the classic arcade game, <a href="https://en.wikipedia.org/wiki/Space_Invaders">space invaders</a>, in C++ using only a few dependencies. In this post I will make the game loop run at a fixed time step, add the player and the aliens, and finally add sprite animation.
<!-- TEASER_END --></p>
<p>The complete code of this post can be found <a href="https://github.com/Grieverheart/space_invaders/blob/2d5007b62ef044f9e47b8660d26810d9ea6de636/main.cpp">here</a>.</p>
<h2>Adding the Player and the Alien swarm</h2>
<p>Before adding the player and aliens swarm, we create two data aggregates, i.e. structs,</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="n">Alien</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Player</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">life</span><span class="p">;</span>
<span class="p">};</span>
</pre>


<p>Both the player and alien structs have a position <code>x</code>, <code>y</code> given in pixels from the bottom left corner of the window. In the Player struct, we also include the number of lives of the player. In the classic space invaders arcade games, there are three alien types that differ only in their sprites. We encode this in the <code>type</code> field.
We also introduce a struct for all game related variables,</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="n">Game</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">num_aliens</span><span class="p">;</span>
    <span class="n">Alien</span><span class="o">*</span> <span class="n">aliens</span><span class="p">;</span>
    <span class="n">Player</span> <span class="n">player</span><span class="p">;</span>
<span class="p">};</span>
</pre>


<p>this includes the <code>width</code> and <code>height</code> of the game in pixels, the player, and the aliens as a dynamically allocated array.</p>
<p>As we did previously, we add a sprite for the player, encoded as a bitmap.</p>
<pre class="code literal-block"><span></span><span class="n">Sprite</span> <span class="n">player_sprite</span><span class="p">;</span>
<span class="n">player_sprite</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
<span class="n">player_sprite</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="n">player_sprite</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span>
<span class="p">{</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// .....@.....</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// ....@@@....</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// ....@@@....</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// .@@@@@@@@@.</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @@@@@@@@@@@</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @@@@@@@@@@@</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @@@@@@@@@@@</span>
<span class="p">};</span>
</pre>


<p>We then create and initialize the <code>Game</code> struct,</p>
<pre class="code literal-block"><span></span><span class="n">Game</span> <span class="n">game</span><span class="p">;</span>
<span class="n">game</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">buffer_width</span><span class="p">;</span>
<span class="n">game</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">buffer_height</span><span class="p">;</span>
<span class="n">game</span><span class="p">.</span><span class="n">num_aliens</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
<span class="n">game</span><span class="p">.</span><span class="n">aliens</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Alien</span><span class="p">[</span><span class="n">game</span><span class="p">.</span><span class="n">num_aliens</span><span class="p">];</span>

<span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">112</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">life</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</pre>


<p>We set the number of aliens to 55, like in the original arcade game, give the player 3 lives, and set his position near the bottom center of the screen. We then proceed to initialize the alien positions to something reasonable,</p>
<pre class="code literal-block"><span></span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">yi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">yi</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">yi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">xi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="o">++</span><span class="n">xi</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">game</span><span class="p">.</span><span class="n">aliens</span><span class="p">[</span><span class="n">yi</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">+</span> <span class="n">xi</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">game</span><span class="p">.</span><span class="n">aliens</span><span class="p">[</span><span class="n">yi</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">+</span> <span class="n">xi</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">*</span> <span class="n">yi</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>


<p>Finally, in the main loop, we draw the player and all aliens,</p>
<pre class="code literal-block"><span></span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ai</span> <span class="o">&lt;</span> <span class="n">game</span><span class="p">.</span><span class="n">num_aliens</span><span class="p">;</span> <span class="o">++</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">Alien</span><span class="o">&amp;</span> <span class="n">alien</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">aliens</span><span class="p">[</span><span class="n">ai</span><span class="p">];</span>
    <span class="n">buffer_draw_sprite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">alien_sprite</span><span class="p">,</span>
        <span class="n">alien</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">alien</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">rgb_to_uint32</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">buffer_draw_sprite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">player_sprite</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">rgb_to_uint32</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</pre>


<p>and here is the result,
<img src="../files/space-invaders-window-4.png" width="224px" style="display:block;">
This is already starting to look like space invaders, but it's quite static!</p>
<h2>Sprite Animation</h2>
<p>To make the game more dynamic, we of course need to implement player input, but we also need some way to animate the sprites. The animation of sprites in video games is achieved by replacing the sprite with a series of sprites in succession. We thus create a data structure to hold various information about a sprite animation.</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="n">SpriteAnimation</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">loop</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">num_frames</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">frame_duration</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">time</span><span class="p">;</span>
    <span class="n">Sprite</span><span class="o">**</span> <span class="n">frames</span><span class="p">;</span>
<span class="p">};</span>
</pre>


<p>The <code>SpriteAnimation</code> struct is basically an array of <code>Sprite</code>s. Here, we use a pointer-to-pointer type for the sprite storage so that sprites can be shared. If would like to be efficient, we could pack the sprites into spritesheets. In addition, we include a flag to tell us if we should loop over the animation or play it only once, the time between successive frames, and the time spent in the current animation instance. Given the number of frames and a desired duration of an animation, the time between successive frames can be easily calculated. Below, we introduce an additional sprite for our alien,</p>
<pre class="code literal-block"><span></span><span class="n">Sprite</span> <span class="n">alien_sprite1</span><span class="p">;</span>
<span class="n">alien_sprite1</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
<span class="n">alien_sprite1</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">alien_sprite1</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="mi">88</span><span class="p">]</span>
<span class="p">{</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// ..@.....@..</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @..@...@..@</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @.@@@@@@@.@</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @@@.@@@.@@@</span>
    <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// @@@@@@@@@@@</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// .@@@@@@@@@.</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// ..@.....@..</span>
    <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>  <span class="c1">// .@.......@.</span>
<span class="p">};</span>
</pre>


<p>and create a two-frame animation using the two alien sprites,</p>
<pre class="code literal-block"><span></span><span class="n">SpriteAnimation</span><span class="o">*</span> <span class="n">alien_animation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpriteAnimation</span><span class="p">;</span>

<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frame_duration</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sprite</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alien_sprite0</span><span class="p">;</span>
<span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alien_sprite1</span><span class="p">;</span>
</pre>


<p>Note that to make things easier, we measure the frame duration and time in game cycles, i.e. number of loop iterations. To make this work, we need to fix the frame rate. For a simple game like the one we are building, we can use <a href="http://emulation.gametechwiki.com/index.php/Vsync">V-sync</a>, an option wherein video card updates are synchronized with the monitor refresh rate. Most modern monitors have a refresh rate of 60Hz, which means that the monitor is refreshed 60 times per second. Turning on V-sync will make our game a framerate of 60, or an integer multiple of the screen refresh. Unfortunately, this means that the game will run faster on monitors with a larger refresh rate, such as 120Hz or 240Hz monitors.
To turn V-sync on, we call the GLFW function <a href="http://www.glfw.org/docs/latest/group__context.html#ga6d4e0cdf151b5e579bd67f13202994ed"><code>glfwSwapInterval</code></a></p>
<pre class="code literal-block"><span></span><span class="n">glfwSwapInterval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre>


<p>At the end of each frame, we update all animations by advancing the time. If an animation has reached its end, we either delete it, or set its time back to 0, if it is a looping animation.</p>
<pre class="code literal-block"><span></span><span class="o">++</span><span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">==</span> <span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">*</span> <span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frame_duration</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">)</span> <span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">delete</span> <span class="n">alien_animation</span><span class="p">;</span>
        <span class="n">alien_animation</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>


<p>Note, that we currently only have one animation we need to update.</p>
<p>In the main loop where we draw the aliens, we update the drawing loop to draw the appropriate frame of the animation. The appropriate frame is calculated based on the time spent in the animation and the frame duration,</p>
<pre class="code literal-block"><span></span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ai</span> <span class="o">&lt;</span> <span class="n">game</span><span class="p">.</span><span class="n">num_aliens</span><span class="p">;</span> <span class="o">++</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">Alien</span><span class="o">&amp;</span> <span class="n">alien</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">aliens</span><span class="p">[</span><span class="n">ai</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">current_frame</span> <span class="o">=</span> <span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">/</span> <span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frame_duration</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">Sprite</span><span class="o">&amp;</span> <span class="n">sprite</span> <span class="o">=</span> <span class="o">*</span><span class="n">alien_animation</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">[</span><span class="n">current_frame</span><span class="p">];</span>
    <span class="n">buffer_draw_sprite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sprite</span><span class="p">,</span> <span class="n">alien</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">alien</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">rgb_to_uint32</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre>


<p>To make things more interesting, we also add some arbitrary player movement, by introducing a variable that controls the player direction of movement, </p>
<pre class="code literal-block"><span></span><span class="kt">int</span> <span class="n">player_move_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre>


<p>and updating the player movement at the end of each frame based on it,</p>
<pre class="code literal-block"><span></span><span class="k">if</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">player_sprite</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">player_move_dir</span> <span class="o">&gt;=</span> <span class="n">game</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">game</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">player_sprite</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">player_move_dir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">player_move_dir</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">player_move_dir</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">player_move_dir</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="n">game</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">player_move_dir</span><span class="p">;</span>
</pre>


<p>The if conditions perform a basic collision detection of the player sprite with the game bounds, ensuring that the player stays within these bounds.
<img src="../files/space-invaders-anim.gif" width="224px" style="display:block; padding:1em 0;">
Above you can see an animated gif of the result.</p>
<h2>Conclusion</h2>
<p>In this post, we set up some structs to logically group data for the game, the player, and the aliens. More importantly, we laid the groundwork for sprite animations. For this simple space invaders game, we assume a fixed clock which we set by turning V-sync on. This allows us to do sprite animation in game cycles instead of real time.</p>
<p>The only thing that is left before making the game playable, is the processing of user input. User input can come from various sources, but we will limit ourselves to the keyboard.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="space-invaders-from-scratch-part-2.html" rel="prev" title="Space Invaders from Scratch - Part 2">Previous post</a>
            </li>
            <li class="next">
                <a href="space-invaders-from-scratch-part-4.html" rel="next" title="Space Invaders from Scratch - Part 4">Next post</a>
            </li>
        </ul></nav></aside></article></main>
</div>
    
    

    
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-115952579-1', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
